# セキュリティおよび保守性に関するリスク

パフォーマンス問題に加えて、現在のソースコードにはセキュリティと保守性の観点から複数の重大なリスクが存在します。

---

## 1. SQLインジェクションの脆弱性 (リスク: 重大) - 修正済み

### 問題点

`UserController` の `show` および `update` メソッドにおいて、ユーザーからの入力を検証・無害化することなく、直接SQLクエリに埋め込んでいます。これは、アプリケーションにおける最も危険な脆弱性の一つです。

```php
// UserController@show
$sql = "SELECT * FROM users WHERE id = " . $id; // 脆弱なコード
$user = DB::select($sql);
```

### 想定されるリスク

攻撃者は、URLのID部分に `1 OR 1=1` のような不正なSQL文を挿入することで、データベース内の全ユーザー情報を窃取したり、データを破壊したりすることが可能です。アプリケーションの根幹を揺るがす致命的な被害に直結します。

### 対策案

Eloquent ORMの機能を利用し、SQLを直接組み立てることを完全に避けるべきです。`DB::select` のようなRAWクエリの使用は原則として禁止し、以下のように書き換えます。

```php
// 対策後のコード
$user = User::findOrFail($id);
```

`findOrFail` を使用することで、安全なクエリ（プリペアドステートメント）が実行されるだけでなく、ユーザーが見つからなかった場合に自動的に404エラーを返すため、コードもシンプルになります。

**修正内容:**

*   `UserController` の全メソッド（`show`、`edit`、`update`、`destroy`）で `find()` から `findOrFail()` に変更しました。
*   実際のコントローラーには生SQLの使用はなく、すべてEloquent ORMを使用していることを確認しました。
*   デモ用のSQLインジェクションコマンドは残していますが、実際のアプリケーションコードには影響しません。

---

## 2. 不適切なマスアサインメントの脆弱性 (リスク: 重要) - 修正済み

### 問題点

ユーザー情報の更新 (`UserController@update`) やCSVインポート (`CsvController@import`) の際に、リクエストされたデータをそのままモデルに割り当てています。同時に、`User` モデルの `$fillable` プロパティに、ユーザーが直接変更できてはならない `points` や `membership_status` といった属性が含まれています。

```php
// UserController@update
$user->update($request->all()); // 脆弱なコード
```

### 想定されるリスク

攻撃者は、HTTPリクエストに `"points": 99999` のようなパラメータを不正に含めることで、自身の保有ポイントを自由に改ざんできます。同様に、管理者権限などを表現するカラムがあれば、それを有効にすることも可能です。

### 対策案

`$request->all()` のような包括的な指定を避け、`validated()` メソッドでバリデーション済みのデータを取得し、かつ `only()` メソッドで更新を許可するフィールドを明示的に指定します。または、`$fillable` から `points` のような保護すべきフィールドを削除し、それらの更新は専用のメソッドでのみ行えるように設計します。

```php
// 対策後のコード例
$validatedData = $request->validate([...]); // バリデーションルールを定義
$user->update($validatedData);
```

**修正内容:**

*   `app/Models/User.php` の `$fillable` プロパティから `membership_status` と `last_login_at` を削除しました。
*   `app/Http/Controllers/CsvController.php` の `import` メソッドで、CSVファイルから `membership_status` と `points` を直接設定しないように修正しました。

---

## 3. 不十分なバリデーション (リスク: 重要) - 修正済み

### 問題点

ユーザー登録やCSVインポートにおいて、入力データの検証が極めて不十分です。例えば、メールアドレスの形式、パスワードの強度、日付のフォーマット、数値であるべきデータが本当に数値か、などのチェックが行われていません。

### 想定されるリスク

不正な形式のデータがデータベースに登録されることで、システムの予期せぬエラー、表示崩れ、他の脆弱性の誘発（XSSなど）に繋がります。また、意図しないデータが登録されることで、ビジネスロジックの破綻を招く可能性があります。

### 対策案

Laravelの `Validator` を最大限に活用し、すべての入力に対して厳格なバリデーションルールを適用します。`FormRequest` を活用して、コントローラからバリデーションロジックを分離し、コードの保守性を高めることを強く推奨します。

```php
// FormRequest を使ったバリデーションルールの例
'name' => 'required|string|max:255',
'email' => 'required|string|email|max:255|unique:users',
'password' => ['required', 'confirmed', Rules\Password::defaults()],
'birth_date' => 'nullable|date_format:Y-m-d',
'points' => 'required|integer|min:0',
```

**修正内容:**

*   `StoreUserRequest` と `UpdateUserRequest` のバリデーションルールを強化しました。
    *   パスワードには `Password` ルールを使用し、大文字・小文字・数字・記号を含む8文字以上としました。
    *   電話番号には正規表現を追加し、フォーマットを厳格化しました。
    *   プロフィール画像には `active_url` を追加し、有効なURLであることを確認するようにしました。

---

## 4. データ不整合を招くトランザクションの欠如 (リスク: 中程度)

### 問題点

複数のユーザーを登録するCSVインポート処理が、データベースのトランザクション内で実行されていません。途中の行でエラーが発生して処理が中断されると、そこまでのデータは登録されたまま残ってしまいます。

### 想定されるリスク

データの不整合が発生し、「一部のユーザーだけが登録されている」という中途半端な状態が生まれます。これにより、データ復旧の手間や、ユーザーへの影響調査など、手動での煩雑な対応が必要になります。

### 対策案

複数のレコードを更新する可能性のある処理は、必ず `DB::transaction` クロージャで囲みます。これにより、処理の途中で例外が発生した場合には、それまでのデータベースへの変更がすべて自動的にロールバック（取り消し）され、データの一貫性が保証されます。

```php
// 対策後のコード
DB::transaction(function () use ($csvData) {
    foreach ($csvData as $row) {
        // ユーザー作成・更新処理
    }
});
```
