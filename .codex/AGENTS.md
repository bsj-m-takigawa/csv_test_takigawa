# AGENTS.md（共通ガイドライン / 日本語）

本ドキュメントは Codex CLI 等のエージェントが本リポジトリで作業する際の、共通ルールと振る舞いを定義します。原則として、日本語で読み・書き・対話を行ってください。

## 目的
- 一貫した日本語対応と、実務的で安全な作業手順を提供する。
- 変更範囲を最小化しつつ、根本原因を直す高品質な修正を優先する。
- ツールの使い分け（apply_patch / shell / update_plan）と承認フローを明確にする。

関連ドキュメント: 詳細な設計/コーディング原則は `docs/coding-guidelines.md` を参照。

## 日本語ポリシー
- 返答・説明・質疑は日本語で行う（技術語・識別子・コード・コマンドは英語表記可）。
- 文体は簡潔・ていねい・事実ベース。推測は「仮説」として明示。
- 不明点や曖昧さは早めに短く確認（例：「〜で合っていますか？」）。

## メッセージングの基本
- 作業前に1–2文で何をするか短い予告（プレアンブル）。
- 複数ステップや長時間の作業は`update_plan`で計画・進捗を共有。
- 最終メッセージでは「何を・なぜ・どこを」変えたかを簡潔に要約し、次の推奨アクションを添える。
- 重い装飾は避ける。必要に応じて短い見出しと箇条書きを使用。コード/コマンド/パスはバッククォートで囲む。

## 作業時チェックリスト（要点）
- 単一責任・高凝集/低結合を維持（詳細は`docs/coding-guidelines.md`）。
- 型安全と入力検証（境界でランタイム検証、内部は正規化）。
- ログレベルと機密データのマスキングを順守。
- 最小差分・小さなステップ・可逆な変更。
- 影響範囲に絞ったテスト/リンタ/型チェックを実行。

## ツールの使い分け
- 変更は必ず`apply_patch`で行う（直接書き換え禁止）。
- シェル実行は最小限。必要性・範囲を明確にし、破壊的操作は事前に確認。
- 計画が複数手順に及ぶ場合は`update_plan`を活用。常に1件だけ`in_progress`を維持。

## 作業の進め方（標準フロー）
1) 依頼の要点を再確認し、曖昧さがあれば質問。
2) 影響範囲を読み取り（関連ファイル・設定・スクリプト）、最小の変更計画を作成。
3) 必要なら`update_plan`で計画を共有し、着手前に短い予告を送る。
4) `apply_patch`で変更。リスクの高い操作は事前合意を得る。
5) 可能な範囲でローカル検証（既存テスト/型チェック/リンタ/ビルド）を実行。
6) 変更点を要約し、次の推奨ステップを提示。未解決事項は明示。

## 変更ポリシー
- 根本原因の修正を優先。表面的なワークアラウンドは避ける。
- 既存のスタイル/構成/命名規約に合わせる。不要なリネームや大規模リファクタは避ける。
- 関連ドキュメント（README/AGENTS.md/設定ファイル）を必要最小限で更新。
- 秘密情報（キー・トークン）を生成/出力/保存しない。サンプルはプレースホルダで表現。

## 実行・検証
- リポジトリにテストやビルド/リンタがある場合は、影響部分に絞って実行。
- フォーマッタやリンタ設定が存在する場合は、それに従う（例：`npm run lint`、`composer pint` 等）。
- 検証が環境制約で不可な場合は、その旨を明示し、代替の簡易チェックや手動確認手順を提案。

## 安全性と承認
- 破壊的操作（`rm`/`git reset`/大規模削除・置換）は事前に短く合意を取る。
- ネットワーク・外部依存の追加・CI設定変更が必要な場合は、目的と影響を1–2文で説明し承認を求める。
- サンドボックスや権限要請の理由は簡潔に記述（1文）。

## 最終メッセージの構成（推奨）
- 変更概要: 要点を1–3行で。
- 影響範囲: 主要なファイル/エンドポイント/コンポーネント。
- 検証: 実施したチェック（テスト/ビルド/リンタ）と結果。
- 次の一手: 推奨タスク（任意: 実行可否の確認質問）。

## よくあるタスクの指針
- バグ修正: 再現手順→原因特定→最小修正→回帰確認。似た箇所の横展開は必要最小限。
- 新機能: 小さく分割。既存API/型/UIパターンを踏襲。後方互換を意識。
- リファクタ: 振る舞い不変を前提に小さなステップで。計測可能な改善を添える。
- ドキュメント: 実装に追随する最小更新。図や長文は必要性が高い場合のみ。

## 禁止事項
- 無断で依存追加や大規模フォーマット変更。
- ライセンス/著作権ヘッダの追加・変更（明示依頼がある場合を除く）。
- 不要なファイル/フォルダの新規作成や命名変更。
- 事実に基づかない断定や、根拠のない性能/安全性の主張。

## 雛形（プレアンブル）
- 「設定を確認したので、関連ファイルを調べます。」
- 「方針が固まったので、最小差分で修正します。」
- 「前段の修正を踏まえ、テストを実行します。」

## 雛形（最終メッセージ）
- 変更概要: `…を実装/修正。…の根本原因を解消。`
- 影響範囲: `…/…/… を変更。後方互換は維持。`
- 検証: `…を実行し、エラーなし/ビルド成功を確認。`
- 次の一手: `必要なら…を拡張/デプロイ/レビューしますか？`

## リポジトリ固有ルールの取り込み
- まず`README`や`CONTRIBUTING`、各種設定（リンタ/フォーマッタ/ビルド）を確認して踏襲。
- 言語/フレームワーク固有のコマンドは`package.json`の`scripts`、`Makefile`、各種マニフェストを参照。

## トラブル時の対応
- 制約（権限/ネットワーク/依存不足）で作業が進まない場合は、回避策と必要承認を簡潔に提示。
- 再現できない/情報不足の場合は、最小の追加情報リクエストを行う（ログ/入力/期待値）。

## 型の安全性
- 原則: 型安全を優先し、境界（API/CLI/環境変数/ファイルI/O）でランタイム検証を行う。
- 依存の扱い: 既存の型/バリデーション仕組みがある場合はそれを使用。新規ライブラリ導入は承認を得る。
- 共通:
  - 「受ける所で厳密、内部は単純」を徹底（入力は厳格に検証、内部表現は整形後に扱う）。
  - 型の曖昧さは早期に解消（null/undefined/空文字/0 の区別）。
- TypeScript 指針:
  - `any`は原則禁止。必要な場合は局所化し、理由と代替案をコメントで明記。`unknown`+型ガードを優先。
  - 戻り値型を明示。狭い型（リテラル型/判別共用体）で表現。`readonly`/`as const`を活用。
  - 外部データ（API/CSV/env）は静的型だけでなくランタイム検証も併用（既存のスキーマ/バリデータがある場合のみ使用）。
  - 例外とエラーは構造化して扱い、`try/catch`で型安全に分岐。
- PHP/Laravel 指針:
  - パラメータ/戻り値/プロパティに型宣言を付与。nullableは意図がある場合のみ。
  - 入力はFormRequest/Validatorで検証し、DTO/値オブジェクトにマッピングしてから処理。
  - 列挙/ユニオン相当の表現には`enum`や定数を活用。配列の連想乱用を避け、意味のある型へ。
  - キャスト/アクセサで永続層とアプリ層の型差を吸収。
- テスト:
  - 境界の検証（正常/境界/異常）と型に関わる回帰ケースを最小でカバー。

## セキュリティ例外の扱い
- 定義: 標準のセキュリティ基準を一時的に緩和/変更する対応（例: CORS拡大、認可緩和、詳細デバッグログの一時有効化）。
- 必須事項（実施前に明記・承認）:
  - 目的/背景、対象範囲、期限（タイムボックス）、リスク、補償制御（レート制限/監視/アラート）、ロールバック手順、承認者。
- 実装原則:
  - フィーチャーフラグ/設定で切替可能にし、既定は安全側（deny-by-default）。
  - 可能な限りスコープを限定（特定エンドポイント/特定オリジン/特定ロール）。
  - 実施期間中は監視とログを強化し、終了後に確実に原状回復。

## ログレベル運用
- レベル定義: `trace`（詳細追跡）, `debug`（開発調査）, `info`（状態変化）, `warn`（想定外だが継続）, `error`（機能失敗）, `fatal`（プロセス継続不能）。
- 原則:
  - 本番では`debug/trace`は原則無効。必要時はタイムボックスとチケット紐付け。
  - 構造化ログ（JSON）と相関ID（例: `requestId`）を付与。サンプリング/レート制限を適用。
  - 入力全量のダンプは禁止。要点のみ、件数やハッシュ化IDで代替。
- 使い分けの目安:
  - `info`: 起動、設定の要約、重要な状態遷移、ジョブ完了（件数/所要時間）。
  - `warn`: リトライで回復する一過性、非推奨パスの利用、入力の軽微不整合。
  - `error`: リクエスト失敗、永続化失敗、外部依存の致命的エラー（PIIは含めない）。
  - `fatal`: 初期化不能、整合性崩壊、プロセスを停止すべき状態。

## 機密データのマスキング
- 対象: 認証情報（パスワード/トークン/APIキー/セッション/Cookie/Authorizationヘッダ）、個人情報、支払い情報、秘密鍵、内部IDの生値等。
- 原則:
  - ログ・エラーメッセージ・チャット回答・ドキュメントに機密を出力しない。必要最小限でも原則はマスク/ハッシュ/トークナイズ。
  - 代表的キー名は強制レダクション（例: `password`, `token`, `secret`, `apiKey`, `authorization`, `set-cookie`）。
  - サンプル/添付/CSVは疑似データに差し替え。実データは保管しない・持ち出さない。
- 実装メモ:
  - ログユーティリティでレダクションのキー/パターンを共通化。失敗時の入力は件数やハッシュで表現。
  - IDは末尾数桁のみ表示（例: `****-1234`）やハッシュ化（不可逆）を使用。
  - どうしても例外が必要な場合は「セキュリティ例外の扱い」に従い、範囲と期限を明記して承認を得る。

## 修正が難航した場合の対応
- 判断基準: 次のいずれかで難航と見なす。
  - 30–60分以上、根本原因の特定に進展がない。
  - 再現が不安定、もしくは外部依存（API/DB/ネットワーク）がボトルネック。
  - 影響範囲が拡大し、最小差分での収束が困難。
- 初動（優先度順）:
  - 状況の可視化: 簡潔な現状サマリ（症状/期待/差分/試行/ログ/仮説/次手）を作成。
  - スコープ圧縮: 再現最小化（最小入力/最小環境/最小コード）と差分切り出し。
  - 切り分け: 依存の無効化・スタブ化・バージョン固定・設定差替えで要因を分離。
  - 観測強化: ログ・メトリクス・アサーションを最小限追加（恒久化が妥当なら残す）。
  - 代替案の提示: 暫定回避（機能制限/リトライ/タイムアウト/フォールバック）を比較検討。
- タイムボックスと報告:
  - デフォルトの検証タイムボックスは60分。30分時点で中間報告。
  - 継続/中断/代替（暫定回避・段階導入・後回し）の判断を提案付きで提示。
- エスカレーション雛形（質問/承認）:
  - 情報リクエスト: 「目的/現象/期待/再現手順/ログ抜粋/試したこと/仮説/欲しい追加情報」。
  - 権限・操作承認: 「目的/実行コマンドまたは変更/影響範囲/ロールバック手順/想定所要」。
- 代替案カタログ:
  - フィーチャーフラグ/設定ゲートで段階公開。
  - 一時的フォールバック（旧アルゴリズム/キャッシュ利用/再試行）。
  - 入力制限やガード追加で不正ケースを回避。
  - 非本質機能の一時停止またはデグレード。
- ロールバック/セーフティ:
  - 変更は小さく分割し、差分ごとに動作確認できる状態を維持。
  - ロールバック手順を明記（差分撤回、設定復元、フラグオフ）。
  - 永続化やスキーマ変更は可逆性と互換を確認（マイグレーションの段階適用など）。
- 記録と引き継ぎ:
  - 最小再現例、観測結果、試行ログ、仮説と結論、未解決点を簡潔に残す。
  - 次の具体アクション（誰が/何を/いつまで）を1–3項目で提案。

---
このガイドは共通利用を想定した最小セットです。プロジェクトで追加のルールがある場合は、プロジェクト固有のAGENTS.mdに追記してください。
